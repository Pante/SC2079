{"version":3,"names":["_helperPluginUtils","require","_pluginSyntaxFunctionSent","_helperWrapFunction","_core","_default","exports","default","declare","api","assertVersion","isFunctionSent","node","t","isIdentifier","meta","name","property","hasBeenReplaced","sentId","isAssignmentExpression","left","yieldVisitor","Function","path","skip","YieldExpression","parent","replaceWith","assignmentExpression","identifier","MetaProperty","inherits","syntaxFunctionSent","visitor","state","fnPath","getFunctionParent","generator","Error","scope","generateUid","traverse","body","unshift","variableDeclaration","variableDeclarator","yieldExpression","wrapFunction","addHelper"],"sources":["../src/index.ts"],"sourcesContent":["import { declare } from \"@babel/helper-plugin-utils\";\nimport syntaxFunctionSent from \"@babel/plugin-syntax-function-sent\";\nimport wrapFunction from \"@babel/helper-wrap-function\";\nimport { types as t } from \"@babel/core\";\nimport type { Visitor } from \"@babel/traverse\";\n\nexport default declare(api => {\n  api.assertVersion(\n    process.env.BABEL_8_BREAKING && process.env.IS_PUBLISH\n      ? PACKAGE_JSON.version\n      : 7,\n  );\n\n  const isFunctionSent = (node: t.MetaProperty) =>\n    t.isIdentifier(node.meta, { name: \"function\" }) &&\n    t.isIdentifier(node.property, { name: \"sent\" });\n\n  const hasBeenReplaced = (\n    node: t.Node,\n    sentId: string,\n  ): node is t.AssignmentExpression =>\n    t.isAssignmentExpression(node) &&\n    t.isIdentifier(node.left, { name: sentId });\n\n  const yieldVisitor: Visitor<{ sentId: string }> = {\n    Function(path) {\n      path.skip();\n    },\n\n    YieldExpression(path) {\n      if (!hasBeenReplaced(path.parent, this.sentId)) {\n        path.replaceWith(\n          t.assignmentExpression(\"=\", t.identifier(this.sentId), path.node),\n        );\n      }\n    },\n\n    MetaProperty(path) {\n      if (isFunctionSent(path.node)) {\n        path.replaceWith(t.identifier(this.sentId));\n      }\n    },\n  };\n\n  return {\n    name: \"proposal-function-sent\",\n    inherits: syntaxFunctionSent,\n\n    visitor: {\n      MetaProperty(path, state) {\n        if (!isFunctionSent(path.node)) return;\n\n        const fnPath = path.getFunctionParent();\n\n        if (!fnPath.node.generator) {\n          throw new Error(\"Parent generator function not found\");\n        }\n\n        const sentId = path.scope.generateUid(\"function.sent\");\n\n        fnPath.traverse(yieldVisitor, { sentId });\n        // @ts-expect-error A generator must not be an arrow function\n        fnPath.node.body.body.unshift(\n          t.variableDeclaration(\"let\", [\n            t.variableDeclarator(t.identifier(sentId), t.yieldExpression()),\n          ]),\n        );\n\n        wrapFunction(fnPath, state.addHelper(\"skipFirstGeneratorNext\"));\n      },\n    },\n  };\n});\n"],"mappings":";;;;;;AAAA,IAAAA,kBAAA,GAAAC,OAAA;AACA,IAAAC,yBAAA,GAAAD,OAAA;AACA,IAAAE,mBAAA,GAAAF,OAAA;AACA,IAAAG,KAAA,GAAAH,OAAA;AAAyC,IAAAI,QAAA,GAAAC,OAAA,CAAAC,OAAA,GAG1B,IAAAC,0BAAO,EAACC,GAAG,IAAI;EAC5BA,GAAG,CAACC,aAAa,CAGX,CACN,CAAC;EAED,MAAMC,cAAc,GAAIC,IAAoB,IAC1CC,WAAC,CAACC,YAAY,CAACF,IAAI,CAACG,IAAI,EAAE;IAAEC,IAAI,EAAE;EAAW,CAAC,CAAC,IAC/CH,WAAC,CAACC,YAAY,CAACF,IAAI,CAACK,QAAQ,EAAE;IAAED,IAAI,EAAE;EAAO,CAAC,CAAC;EAEjD,MAAME,eAAe,GAAGA,CACtBN,IAAY,EACZO,MAAc,KAEdN,WAAC,CAACO,sBAAsB,CAACR,IAAI,CAAC,IAC9BC,WAAC,CAACC,YAAY,CAACF,IAAI,CAACS,IAAI,EAAE;IAAEL,IAAI,EAAEG;EAAO,CAAC,CAAC;EAE7C,MAAMG,YAAyC,GAAG;IAChDC,QAAQA,CAACC,IAAI,EAAE;MACbA,IAAI,CAACC,IAAI,CAAC,CAAC;IACb,CAAC;IAEDC,eAAeA,CAACF,IAAI,EAAE;MACpB,IAAI,CAACN,eAAe,CAACM,IAAI,CAACG,MAAM,EAAE,IAAI,CAACR,MAAM,CAAC,EAAE;QAC9CK,IAAI,CAACI,WAAW,CACdf,WAAC,CAACgB,oBAAoB,CAAC,GAAG,EAAEhB,WAAC,CAACiB,UAAU,CAAC,IAAI,CAACX,MAAM,CAAC,EAAEK,IAAI,CAACZ,IAAI,CAClE,CAAC;MACH;IACF,CAAC;IAEDmB,YAAYA,CAACP,IAAI,EAAE;MACjB,IAAIb,cAAc,CAACa,IAAI,CAACZ,IAAI,CAAC,EAAE;QAC7BY,IAAI,CAACI,WAAW,CAACf,WAAC,CAACiB,UAAU,CAAC,IAAI,CAACX,MAAM,CAAC,CAAC;MAC7C;IACF;EACF,CAAC;EAED,OAAO;IACLH,IAAI,EAAE,wBAAwB;IAC9BgB,QAAQ,EAAEC,iCAAkB;IAE5BC,OAAO,EAAE;MACPH,YAAYA,CAACP,IAAI,EAAEW,KAAK,EAAE;QACxB,IAAI,CAACxB,cAAc,CAACa,IAAI,CAACZ,IAAI,CAAC,EAAE;QAEhC,MAAMwB,MAAM,GAAGZ,IAAI,CAACa,iBAAiB,CAAC,CAAC;QAEvC,IAAI,CAACD,MAAM,CAACxB,IAAI,CAAC0B,SAAS,EAAE;UAC1B,MAAM,IAAIC,KAAK,CAAC,qCAAqC,CAAC;QACxD;QAEA,MAAMpB,MAAM,GAAGK,IAAI,CAACgB,KAAK,CAACC,WAAW,CAAC,eAAe,CAAC;QAEtDL,MAAM,CAACM,QAAQ,CAACpB,YAAY,EAAE;UAAEH;QAAO,CAAC,CAAC;QAEzCiB,MAAM,CAACxB,IAAI,CAAC+B,IAAI,CAACA,IAAI,CAACC,OAAO,CAC3B/B,WAAC,CAACgC,mBAAmB,CAAC,KAAK,EAAE,CAC3BhC,WAAC,CAACiC,kBAAkB,CAACjC,WAAC,CAACiB,UAAU,CAACX,MAAM,CAAC,EAAEN,WAAC,CAACkC,eAAe,CAAC,CAAC,CAAC,CAChE,CACH,CAAC;QAED,IAAAC,2BAAY,EAACZ,MAAM,EAAED,KAAK,CAACc,SAAS,CAAC,wBAAwB,CAAC,CAAC;MACjE;IACF;EACF,CAAC;AACH,CAAC,CAAC"}