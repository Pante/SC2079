{"version":3,"names":["_core","require","isConciseArrowExpression","node","t","isArrowFunctionExpression","isExpression","body","async","buildOptimizedSequenceExpression","call","path","placeholder","callee","calledExpression","pipelineLeft","left","assign","assignmentExpression","cloneNode","expressionIsArrow","param","optimizeArrow","params","length","isIdentifier","sequenceExpression","scope","push","id","get","rename","name","evalSequence","numericLiteral","_default","exports","default"],"sources":["../src/buildOptimizedSequenceExpression.ts"],"sourcesContent":["import { types as t } from \"@babel/core\";\nimport type { NodePath } from \"@babel/traverse\";\n\n// tries to optimize sequence expressions in the format\n//   (a = b, (c => c + e)(a))\n// to\n//   (a = b, a + e)\n\ntype Options = {\n  call: t.CallExpression | t.AwaitExpression;\n  path: NodePath<t.BinaryExpression & { operator: \"|>\" }>;\n  placeholder: t.Identifier;\n};\n\nfunction isConciseArrowExpression(\n  node: t.Node,\n): node is t.ArrowFunctionExpression & { body: t.Expression } {\n  return (\n    t.isArrowFunctionExpression(node) &&\n    t.isExpression(node.body) &&\n    !node.async\n  );\n}\n\nconst buildOptimizedSequenceExpression = ({\n  call,\n  path,\n  placeholder,\n}: Options) => {\n  // @ts-expect-error AwaitExpression does not have callee property\n  const { callee: calledExpression } = call;\n  // pipelineLeft must not be a PrivateName\n  const pipelineLeft = path.node.left as t.Expression;\n  const assign = t.assignmentExpression(\n    \"=\",\n    t.cloneNode(placeholder),\n    pipelineLeft,\n  );\n\n  const expressionIsArrow = isConciseArrowExpression(calledExpression);\n\n  if (expressionIsArrow) {\n    let param;\n    let optimizeArrow = true;\n    const { params } = calledExpression;\n    if (params.length === 1 && t.isIdentifier(params[0])) {\n      param = params[0];\n    } else if (params.length > 0) {\n      optimizeArrow = false;\n    }\n    if (optimizeArrow && !param) {\n      // fixme: arrow function with 1 pattern argument will also go into this branch\n      // Arrow function with 0 arguments\n      return t.sequenceExpression([pipelineLeft, calledExpression.body]);\n    } else if (param) {\n      path.scope.push({ id: t.cloneNode(placeholder) });\n      path.get(\"right\").scope.rename(param.name, placeholder.name);\n\n      return t.sequenceExpression([assign, calledExpression.body]);\n    }\n  } else if (t.isIdentifier(calledExpression, { name: \"eval\" })) {\n    const evalSequence = t.sequenceExpression([\n      t.numericLiteral(0),\n      calledExpression,\n    ]);\n\n    (call as t.CallExpression).callee = evalSequence;\n  }\n  path.scope.push({ id: t.cloneNode(placeholder) });\n\n  return t.sequenceExpression([assign, call]);\n};\n\nexport default buildOptimizedSequenceExpression;\n"],"mappings":";;;;;;AAAA,IAAAA,KAAA,GAAAC,OAAA;AAcA,SAASC,wBAAwBA,CAC/BC,IAAY,EACgD;EAC5D,OACEC,WAAC,CAACC,yBAAyB,CAACF,IAAI,CAAC,IACjCC,WAAC,CAACE,YAAY,CAACH,IAAI,CAACI,IAAI,CAAC,IACzB,CAACJ,IAAI,CAACK,KAAK;AAEf;AAEA,MAAMC,gCAAgC,GAAGA,CAAC;EACxCC,IAAI;EACJC,IAAI;EACJC;AACO,CAAC,KAAK;EAEb,MAAM;IAAEC,MAAM,EAAEC;EAAiB,CAAC,GAAGJ,IAAI;EAEzC,MAAMK,YAAY,GAAGJ,IAAI,CAACR,IAAI,CAACa,IAAoB;EACnD,MAAMC,MAAM,GAAGb,WAAC,CAACc,oBAAoB,CACnC,GAAG,EACHd,WAAC,CAACe,SAAS,CAACP,WAAW,CAAC,EACxBG,YACF,CAAC;EAED,MAAMK,iBAAiB,GAAGlB,wBAAwB,CAACY,gBAAgB,CAAC;EAEpE,IAAIM,iBAAiB,EAAE;IACrB,IAAIC,KAAK;IACT,IAAIC,aAAa,GAAG,IAAI;IACxB,MAAM;MAAEC;IAAO,CAAC,GAAGT,gBAAgB;IACnC,IAAIS,MAAM,CAACC,MAAM,KAAK,CAAC,IAAIpB,WAAC,CAACqB,YAAY,CAACF,MAAM,CAAC,CAAC,CAAC,CAAC,EAAE;MACpDF,KAAK,GAAGE,MAAM,CAAC,CAAC,CAAC;IACnB,CAAC,MAAM,IAAIA,MAAM,CAACC,MAAM,GAAG,CAAC,EAAE;MAC5BF,aAAa,GAAG,KAAK;IACvB;IACA,IAAIA,aAAa,IAAI,CAACD,KAAK,EAAE;MAG3B,OAAOjB,WAAC,CAACsB,kBAAkB,CAAC,CAACX,YAAY,EAAED,gBAAgB,CAACP,IAAI,CAAC,CAAC;IACpE,CAAC,MAAM,IAAIc,KAAK,EAAE;MAChBV,IAAI,CAACgB,KAAK,CAACC,IAAI,CAAC;QAAEC,EAAE,EAAEzB,WAAC,CAACe,SAAS,CAACP,WAAW;MAAE,CAAC,CAAC;MACjDD,IAAI,CAACmB,GAAG,CAAC,OAAO,CAAC,CAACH,KAAK,CAACI,MAAM,CAACV,KAAK,CAACW,IAAI,EAAEpB,WAAW,CAACoB,IAAI,CAAC;MAE5D,OAAO5B,WAAC,CAACsB,kBAAkB,CAAC,CAACT,MAAM,EAAEH,gBAAgB,CAACP,IAAI,CAAC,CAAC;IAC9D;EACF,CAAC,MAAM,IAAIH,WAAC,CAACqB,YAAY,CAACX,gBAAgB,EAAE;IAAEkB,IAAI,EAAE;EAAO,CAAC,CAAC,EAAE;IAC7D,MAAMC,YAAY,GAAG7B,WAAC,CAACsB,kBAAkB,CAAC,CACxCtB,WAAC,CAAC8B,cAAc,CAAC,CAAC,CAAC,EACnBpB,gBAAgB,CACjB,CAAC;IAEDJ,IAAI,CAAsBG,MAAM,GAAGoB,YAAY;EAClD;EACAtB,IAAI,CAACgB,KAAK,CAACC,IAAI,CAAC;IAAEC,EAAE,EAAEzB,WAAC,CAACe,SAAS,CAACP,WAAW;EAAE,CAAC,CAAC;EAEjD,OAAOR,WAAC,CAACsB,kBAAkB,CAAC,CAACT,MAAM,EAAEP,IAAI,CAAC,CAAC;AAC7C,CAAC;AAAC,IAAAyB,QAAA,GAAAC,OAAA,CAAAC,OAAA,GAEa5B,gCAAgC"}